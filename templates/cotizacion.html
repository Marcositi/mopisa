{% extends "base.html" %}
{% block title %}Cotizaci贸n | MOPISA{% endblock %}

{% block content %}
<div class="cotizador-container">
    <div class="header-cotizador">
        <h2><i class="fas fa-file-invoice-dollar"></i> Cotizaci贸n de Productos</h2>
        
        <div class="cliente-box">
            {% if user.is_authenticated %}
                <div class="user-info">
                    <span class="user-badge">Bienvenido, <strong>{{ user.username }}</strong> </span>
                    <form action="{% url 'logout' %}?next={% url 'inicio' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn-logout">Cerrar sesi贸n</button>
                    </form>
                </div>
            {% else %}
                <div class="auth-prompt">
                    <p>Inicia sesi贸n para guardar tu cotizaci贸n</p>
                    <div class="auth-btns">
                        <a href="{% url 'login' %}" class="btn-login">Entrar</a>
                        <a href="{% url 'crear_cliente' %}" class="btn-reg">Registro</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <form method="get" action="{% url 'cotizador' %}" class="search-bar">
        <input type="text" name="q" placeholder="Buscar por c贸digo o nombre..." value="{{ request.GET.q }}">
        <button type="submit"><i class="fas fa-search"></i> Buscar</button>
    </form>

    <form id="cotizacion-form" method="post">
        {% csrf_token %}
        <div class="tabla-wrapper">
            <table class="inventario-tabla">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>C贸digo</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr>
                        <td data-label="Producto">
                            <div class="prod-info">
                                {% if producto.imagen %}
                                    <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="thumb">
                                {% else %}
                                    <div class="no-thumb">N/A</div>
                                {% endif %}
                                <span class="prod-name">{{ producto.nombre }}</span>
                            </div>
                        </td>
                        <td data-label="C贸digo" class="text-muted">{{ producto.clave }}</td>
                        <td data-label="Precio" class="text-bold">${{ producto.precio }}</td>
                        <td data-label="Cantidad">
                            <div class="qty-control">
                                <input type="number" name="cantidad_{{ producto.id }}" min="0" value="0" 
                                       class="cantidad-input" data-precio="{{ producto.precio }}" 
                                       data-id="{{ producto.id }}" data-nombre="{{ producto.nombre }}">
                            </div>
                        </td>
                        <td data-label="Subtotal" class="subtotal-cell">$0.00</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="empty-state">No se encontraron productos.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="resumen-flotante">
            <div class="total-section">
                <span>Total Estimado:</span>
                <strong id="total">$0.00</strong>
            </div>
            <div class="action-buttons">
                <button type="submit" name="generar" value="1" class="btn-main">Generar Cotizaci贸n</button>
                <a href="{% url 'cotizaciones_cliente' %}" class="btn-link-sec">Mis Cotizaciones</a>
            </div>
        </div>
    </form>
</div>

<style>
    :root {
        --mopisa-brown: #33271b;
        --mopisa-orange: #e08844;
        --border-color: #eee;
    }

    .cotizador-container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }

    /* Header y Cliente */
    .header-cotizador h2 { color: var(--mopisa-brown); margin-bottom: 20px; text-align: center; }
    .cliente-box { background: #fff; border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .user-info { display: flex; justify-content: space-between; align-items: center; }
    .btn-logout { background: transparent; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }

    /* Buscador */
    .search-bar { display: flex; gap: 10px; margin-bottom: 25px; }
    .search-bar input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
    .search-bar button { background: var(--mopisa-brown); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; }

    /* Tabla Estilizada */
    .tabla-wrapper { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 100px; }
    .inventario-tabla { width: 100%; border-collapse: collapse; }
    .inventario-tabla th { background: #f8f9fa; color: var(--mopisa-brown); padding: 15px; text-align: left; font-size: 0.85em; text-transform: uppercase; }
    .inventario-tabla td { padding: 15px; border-bottom: 1px solid #f1f1f1; }

    .prod-info { display: flex; align-items: center; gap: 15px; }
    .thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; }
    .no-thumb { width: 50px; height: 50px; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 0.7em; border-radius: 6px; }
    .prod-name { font-weight: 600; color: #333; }

    .cantidad-input { width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
    .subtotal-cell { font-weight: 700; color: var(--mopisa-orange); }

    /* Resumen Flotante */
    .resumen-flotante {
        position: fixed; bottom: 0; left: 0; right: 0; 
        background: var(--mopisa-brown); color: white;
        padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
        z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
    }
    .total-section span { font-size: 0.9em; opacity: 0.8; }
    .total-section strong { font-size: 1.5em; color: var(--mopisa-orange); margin-left: 10px; }
    .btn-main { background: var(--mopisa-orange); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .btn-link-sec { color: #fff; text-decoration: none; font-size: 0.9em; margin-left: 15px; border-bottom: 1px solid #fff; }

    /*  MVIL: Transformar Tabla en Cards */
    @media (max-width: 768px) {
        .inventario-tabla thead { display: none; }
        .inventario-tabla td { display: block; text-align: right; padding: 10px 15px; border: none; }
        .inventario-tabla td::before { content: attr(data-label); float: left; font-weight: bold; color: #888; text-transform: uppercase; font-size: 0.75em; }
        .inventario-tabla tr { display: block; border-bottom: 2px solid #eee; padding: 15px 0; }
        .prod-info { justify-content: flex-end; }
        .resumen-flotante { flex-direction: column; gap: 15px; padding: 20px; text-align: center; }
        .btn-main { width: 100%; }
    }
</style>

<script>
    document.querySelectorAll(".cantidad-input").forEach(input => {
        input.addEventListener("input", () => {
            const fila = input.closest("tr");
            const precio = parseFloat(input.dataset.precio);
            const cantidad = parseInt(input.value) || 0;
            const subtotal = precio * cantidad;
            fila.querySelector(".subtotal-cell").textContent = "$" + subtotal.toFixed(2);
            
            let total = 0;
            document.querySelectorAll(".subtotal-cell").forEach(cell => {
                total += parseFloat(cell.textContent.replace("$", "")) || 0;
            });
            document.getElementById("total").textContent = "$" + total.toFixed(2);
        });
    });
</script>
{% endblock %}